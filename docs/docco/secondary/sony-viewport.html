<!DOCTYPE html>  <html> <head>   <title>sony-viewport.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="debug_toggle.html">                 debug_toggle.js               </a>                                           <a class="source" href="form-actions.html">                 form-actions.js               </a>                                           <a class="source" href="jodo.rangecontrol.1.4.html">                 jodo.rangecontrol.1.4.js               </a>                                           <a class="source" href="jquery.shuffle.html">                 jquery.shuffle.js               </a>                                           <a class="source" href="jquery.simpleknob.html">                 jquery.simpleknob.js               </a>                                           <a class="source" href="jquery.simplescroll.html">                 jquery.simplescroll.js               </a>                                           <a class="source" href="sony-carousel-fade.html">                 sony-carousel-fade.js               </a>                                           <a class="source" href="sony-carousel.html">                 sony-carousel.js               </a>                                           <a class="source" href="sony-draggable.html">                 sony-draggable.js               </a>                                           <a class="source" href="sony-evenheights.html">                 sony-evenheights.js               </a>                                           <a class="source" href="sony-favorites.html">                 sony-favorites.js               </a>                                           <a class="source" href="sony-img-sequence.html">                 sony-img-sequence.js               </a>                                           <a class="source" href="sony-modal.html">                 sony-modal.js               </a>                                           <a class="source" href="sony-navigationdots.html">                 sony-navigationdots.js               </a>                                           <a class="source" href="sony-paddles.html">                 sony-paddles.js               </a>                                           <a class="source" href="sony-scroller.html">                 sony-scroller.js               </a>                                           <a class="source" href="sony-scrolltotop.html">                 sony-scrolltotop.js               </a>                                           <a class="source" href="sony-sequencer.html">                 sony-sequencer.js               </a>                                           <a class="source" href="sony-stickyheaders.html">                 sony-stickyheaders.js               </a>                                           <a class="source" href="sony-stickynav.html">                 sony-stickynav.js               </a>                                           <a class="source" href="sony-stickytabs.html">                 sony-stickytabs.js               </a>                                           <a class="source" href="sony-tab.html">                 sony-tab.js               </a>                                           <a class="source" href="sony-video.html">                 sony-video.js               </a>                                           <a class="source" href="sony-viewport.html">                 sony-viewport.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               sony-viewport.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Viewport Helper</h2>

<ul>
<li><strong>Class:</strong> Viewport</li>
<li><strong>Version:</strong> 1.0</li>
<li><strong>Modified:</strong> 06/26/2013</li>
<li><strong>Author:</strong> Glen Cheney</li>
<li><strong>Dependencies:</strong> jQuery 1.7+, SONY Settings, throttle/debounce</li>
</ul>

<p><em>Notes:</em></p>

<p>If you need to be notified when an element is scrolled into view, use this module.
This module keeps track of all elements that want to be watched and caches their offsets
and dimensions in order to keep scrolling as smooth as possible.</p>

<p><em>Example Usage:</em></p>

<pre><code> Viewport.add( element, callback )

 Viewport.add( options )
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>
define(<span class="keyword">function</span>(require) {

  <span class="string">'use strict'</span>;

  <span class="keyword">var</span> $ = require(<span class="string">'jquery'</span>),
      Environment = require(<span class="string">'require/sony-global-environment'</span>),
      Settings = require(<span class="string">'require/sony-global-settings'</span>),

      instance = <span class="literal">null</span>;

  <span class="keyword">var</span> Viewport = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.init();
  };

  Viewport.prototype = {

    init : <span class="keyword">function</span>() {
      <span class="keyword">var</span> self = <span class="keyword">this</span>;

</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The list of viewports to watch</p>             </td>             <td class="code">               <div class="highlight"><pre>      self.list = [];
      self.lastScrollY = <span class="number">0</span>;
      self.windowHeight = Settings.$window.height();
      self.windowWidth = Settings.$window.width();
      self.throttleTime = <span class="number">250</span>;

      self.onResize();
      self.bindEvents();

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>What's nice here is that rAF won't execute until the user is on this tab,
so if they open the page in a new tab which they aren't looking at,
this will execute when they come back to that tab</p>             </td>             <td class="code">               <div class="highlight"><pre>      requestAnimationFrame(<span class="keyword">function</span>() {
        self.setScrollTop();
        self.process();
      });
    },

    bindEvents : <span class="keyword">function</span>() {
      <span class="keyword">var</span> self = <span class="keyword">this</span>;

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Listen for global resize</p>             </td>             <td class="code">               <div class="highlight"><pre>      Environment.on(<span class="string">'global:resizeDebounced.viewport'</span>, $.proxy( self.onResize, self ));

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Throttle scrolling because it doesn't need to be super accurate</p>             </td>             <td class="code">               <div class="highlight"><pre>      Settings.$window.on(<span class="string">'scroll.viewport'</span>, $.throttle( self.throttleTime, $.proxy( self.onScroll, self ) ));

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>When the universal nav is opened or closed, the trigger point needs adjustment along with scrollspy</p>             </td>             <td class="code">               <div class="highlight"><pre>      Settings.$document.on(<span class="string">'universal-nav-open-finished.viewport universal-nav-close-finished.viewport'</span>, <span class="function"><span class="keyword">function</span> <span class="title">uNavChanged</span><span class="params">()</span> {</span>
        setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">refreshWithDelay</span><span class="params">()</span> {</span>
          self.onResize();
        }, <span class="number">0</span>);
      });

      self.hasActiveHandlers = <span class="literal">true</span>;
    },

    unbindEvents : <span class="keyword">function</span>() {
      Environment.off(<span class="string">'.viewport'</span>);
      Settings.$window.off(<span class="string">'.viewport'</span>);
      Settings.$document.off(<span class="string">'.viewport'</span>);

      <span class="keyword">this</span>.hasActiveHandlers = <span class="literal">false</span>;
    },

    maybeUnbindEvents : <span class="keyword">function</span>() {
      <span class="keyword">var</span> self = <span class="keyword">this</span>;

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Not currently watching anything, unbind events</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> ( !self.list.length ) {
        self.unbindEvents();
      }
    },

    add : <span class="keyword">function</span>( options ) {
      <span class="keyword">var</span> self = <span class="keyword">this</span>,
          isThresholdPercentage = <span class="literal">false</span>;

</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The whole point is to have a callback function.
Don't do anything if it's not given</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> ( !$.isFunction( options.callback ) ) {
        <span class="keyword">throw</span> <span class="string">'Viewport.add :: No callback function provided to Viewport'</span>;
      }

</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Threshold can be a percentage. Parse it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> ( (<span class="keyword">typeof</span> options.threshold === <span class="string">'string'</span> &amp;&amp; options.threshold.indexOf(<span class="string">'%'</span>) &gt; -<span class="number">1</span> ) ) {
        isThresholdPercentage = <span class="literal">true</span>;
        options.threshold = parseFloat( options.threshold ) / <span class="number">100</span>;

      } <span class="keyword">else</span> <span class="keyword">if</span> ( options.threshold &lt; <span class="number">1</span> &amp;&amp; options.threshold &gt; <span class="number">0</span> ) {
        isThresholdPercentage = <span class="literal">true</span>;
      }

      options.isThresholdPercentage = isThresholdPercentage;
      options.$element = $( options.element );

</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Cache element's offsets and dimensions</p>             </td>             <td class="code">               <div class="highlight"><pre>      options.offset = options.$element.offset();
      options.height = options.$element.height();
      options.width = options.$element.width();

      self.list.push( options );

</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Event handlers are removed if a callback is triggered and the
watch list is empty. Because modules are instantiated asynchronously,
another module could potentially add itself to the watch list when the events
have been unbound.
Check here if events have been unbound and bind them again if they have</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> ( !self.hasActiveHandlers ) {
        self.bindEvents();
      }

      requestAnimationFrame(<span class="keyword">function</span>() {
        self.process();
      });
    },

    saveDimensions : <span class="keyword">function</span>() {
      <span class="keyword">var</span> self = <span class="keyword">this</span>;

      $.each(self.list, <span class="keyword">function</span>( i, listItem ) {
        listItem.offset = listItem.$element.offset();
        listItem.height = listItem.$element.height();
        listItem.width = listItem.$element.width();
      });

</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>self.documentHeight</p>             </td>             <td class="code">               <div class="highlight"><pre>      self.windowHeight = Settings.$window.height();
      self.windowWidth = Settings.$window.width();
    },

</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Throttled scroll event</p>             </td>             <td class="code">               <div class="highlight"><pre>    onScroll : <span class="keyword">function</span>() {
      <span class="keyword">var</span> self = <span class="keyword">this</span>;

</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>No point in doing anything if there aren't any viewports to watch</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> ( !self.list.length ) {
        <span class="keyword">return</span>;
      }

</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Save the new scroll top</p>             </td>             <td class="code">               <div class="highlight"><pre>      self.setScrollTop();

      self.process();
    },

</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Debounced resize event</p>             </td>             <td class="code">               <div class="highlight"><pre>    onResize : <span class="keyword">function</span>() {
      <span class="keyword">var</span> self = <span class="keyword">this</span>;

</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>No point in doing anything if there aren't any viewports to watch</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> ( !self.list.length ) {
        <span class="keyword">return</span>;
      }

</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Update offsets and width/height for each viewport item</p>             </td>             <td class="code">               <div class="highlight"><pre>      self.saveDimensions();
    },

    isInViewport : <span class="keyword">function</span>( viewport ) {
      <span class="keyword">var</span> self = <span class="keyword">this</span>,
          offset = viewport.offset,
          threshold = viewport.threshold,
          percentage = threshold,
          st = self.lastScrollY,
          isTopInView;


      <span class="keyword">if</span> ( viewport.isThresholdPercentage ) {
        threshold = <span class="number">0</span>;
      }

</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Other checks could be added here in the future</p>             </td>             <td class="code">               <div class="highlight"><pre>      isTopInView = self.isTopInView( st, self.windowHeight, offset.top, viewport.height, threshold );

</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If the top isn't in view with zero threshold,
don't bother checking if it's at a percent of the window</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> ( isTopInView &amp;&amp; viewport.isThresholdPercentage ) {
        isTopInView = self.isTopPastPercent( st, self.windowHeight, offset.top, viewport.height, percentage );
      }

      <span class="keyword">return</span> isTopInView;
    },

</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If  the top of the element (plus the threshold) is past the viewport's top
and the top of the element (plus the threshold) is not past the viewport's bottom.
Then the top is in view.</p>             </td>             <td class="code">               <div class="highlight"><pre>    isTopInView : <span class="keyword">function</span>( viewportTop, viewportHeight, elementTop, elementHeight, threshold ) {
      <span class="keyword">var</span> viewportBottom = viewportTop + viewportHeight;
      <span class="keyword">return</span> (elementTop + threshold) &gt;= viewportTop &amp;&amp; (elementTop + threshold) &lt; viewportBottom;
    },

    isTopPastPercent : <span class="keyword">function</span>( viewportTop, viewportHeight, elementTop, elementHeight, percentage ) {
      <span class="keyword">var</span> viewportBottom = viewportTop + viewportHeight,
          distFromViewportBottomToElementTop = viewportBottom - elementTop,
          percentFromBottom = distFromViewportBottomToElementTop / viewportHeight;
      <span class="keyword">return</span> percentFromBottom &gt;= percentage;
    },

    triggerCallback : <span class="keyword">function</span>( index, listItem ) {
      <span class="keyword">var</span> self = <span class="keyword">this</span>;

      listItem.callback.call( listItem.element, listItem );

</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>No longer need to watch it, so remove from list</p>             </td>             <td class="code">               <div class="highlight"><pre>      self.list.splice( index, <span class="number">1</span> );

</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>If there are no more, unbind from scroll and resize events</p>             </td>             <td class="code">               <div class="highlight"><pre>      self.maybeUnbindEvents();
    },

    setScrollTop : <span class="keyword">function</span>() {
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Save the new scroll top</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">this</span>.lastScrollY = Settings.$window.scrollTop();
    },

    process : <span class="keyword">function</span>() {
      <span class="keyword">var</span> self = <span class="keyword">this</span>,

</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The list can possibly be modified mid loop,
so the loop needs a copy of the variable which won't be modified</p>             </td>             <td class="code">               <div class="highlight"><pre>          list = $.extend( [], self.list );

      $.each(list, <span class="keyword">function</span>( i, listItem ) {
        <span class="keyword">var</span> isInViewport = self.isInViewport( listItem );

        <span class="keyword">if</span> ( isInViewport ) {
          self.triggerCallback( i, listItem );
        }
      });
    }
  };

  Viewport.add = <span class="keyword">function</span>( element, callback ) {
    <span class="keyword">var</span> instance = Viewport.getInstance(),
        options = {};

</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>If the first arg is a plain object, it is an options object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">if</span> ( $.isPlainObject( element ) ) {
      options = element;

</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Otherwise assume it is the element</p>             </td>             <td class="code">               <div class="highlight"><pre>    } <span class="keyword">else</span> {
      options.element = element;
    }

    <span class="keyword">if</span> ( callback ) {
      options.callback = callback;
    }

</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Get defaults</p>             </td>             <td class="code">               <div class="highlight"><pre>    options = $.extend( {}, Viewport.options, options, Viewport.settings );

    <span class="keyword">return</span> instance.add( options );
  };

  Viewport.options = {
    threshold: <span class="number">200</span>
  };

  Viewport.settings = {
  };

  Viewport.getInstance = <span class="keyword">function</span>() {
    <span class="keyword">if</span> ( !instance ) {
      instance = <span class="keyword">new</span> Viewport();
    }

    <span class="keyword">return</span> instance;
  };

  <span class="keyword">return</span> Viewport;
});

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 