<!DOCTYPE html>  <html> <head>   <title>universal-nav.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="SEN-convergence-e12.html">                 SEN-convergence-e12.js               </a>                                           <a class="source" href="alert-module.html">                 alert-module.js               </a>                                           <a class="source" href="country-region-selection-z10.html">                 country-region-selection-z10.js               </a>                                           <a class="source" href="demo-x99.html">                 demo-x99.js               </a>                                           <a class="source" href="360viewer-controller.html">                 360viewer-controller.js               </a>                                           <a class="source" href="editorial-carousel-e13.html">                 editorial-carousel-e13.js               </a>                                           <a class="source" href="editorial-chapters-e5.html">                 editorial-chapters-e5.js               </a>                                           <a class="source" href="editorial-dual-viewer-e9.html">                 editorial-dual-viewer-e9.js               </a>                                           <a class="source" href="hotspots-controller.html">                 hotspots-controller.js               </a>                                           <a class="source" href="editorial-layouts-e1.html">                 editorial-layouts-e1.js               </a>                                           <a class="source" href="editorial-slideshows-e4.html">                 editorial-slideshows-e4.js               </a>                                           <a class="source" href="footnotes-module.html">                 footnotes-module.js               </a>                                           <a class="source" href="gallery-g2-g3.html">                 gallery-g2-g3.js               </a>                                           <a class="source" href="global-header-footer.html">                 global-header-footer.js               </a>                                           <a class="source" href="light-compare-d9.html">                 light-compare-d9.js               </a>                                           <a class="source" href="one-sony-carousel-s2.html">                 one-sony-carousel-s2.js               </a>                                           <a class="source" href="pdp-slideshow-d4.html">                 pdp-slideshow-d4.js               </a>                                           <a class="source" href="primary-tout-p1-d7.html">                 primary-tout-p1-d7.js               </a>                                           <a class="source" href="product-details-d5.html">                 product-details-d5.js               </a>                                           <a class="source" href="product-summary-d1-d2.html">                 product-summary-d1-d2.js               </a>                                           <a class="source" href="recently-viewed.html">                 recently-viewed.js               </a>                                           <a class="source" href="related-products-g1.html">                 related-products-g1.js               </a>                                           <a class="source" href="reviews-awards-d6.html">                 reviews-awards-d6.js               </a>                                           <a class="source" href="search-results-z07.html">                 search-results-z07.js               </a>                                           <a class="source" href="secondary-touts-s1-s4.html">                 secondary-touts-s1-s4.js               </a>                                           <a class="source" href="sony-video.html">                 sony-video.js               </a>                                           <a class="source" href="spec-multi-z2.html">                 spec-multi-z2.js               </a>                                           <a class="source" href="spec-single-z1.html">                 spec-single-z1.js               </a>                                           <a class="source" href="subnavigation-n4.html">                 subnavigation-n4.js               </a>                                           <a class="source" href="tertiary-t1-t5-module.html">                 tertiary-t1-t5-module.js               </a>                                           <a class="source" href="universal-nav.html">                 universal-nav.js               </a>                                           <a class="source" href="unsupported-z19.html">                 unsupported-z19.js               </a>                                           <a class="source" href="ux-marketing-convergence-e14.html">                 ux-marketing-convergence-e14.js               </a>                                           <a class="source" href="whats-new-tout-s4.html">                 whats-new-tout-s4.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               universal-nav.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="comment">/* Universal Nav - Functions as a stand-alone module. */</span>

</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>------------ Sony Universal Nav ------------
Module: Universal Nav
Version: 1.0
Modified: 2013-06-04 by Christopher Mischler
Dependencies: jQuery 1.6+  </p>

<h2>             --- 1.6 is needed for $.is and at the moment nothing else, but that could have changed.</h2>

<p>Events broadcast on $(document): universal-nav-open, universal-nav-open-finished, universal-nav-close, universal-nav-close-finished</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="keyword">var</span> UNAV = ( <span class="keyword">function</span>( window, document, $, <span class="literal">undefined</span> ) {

  <span class="string">'use strict'</span>;

  <span class="keyword">var</span> $triggerLink,
    $pageWrapInner,
    $pageWrapOuter,
    $uNav,
    $uNavPrimary,
    $firstChild,
    $closeBtn,
    $tabableElements,
    $lastTabIndexElement,
    $window,
    imagesInited,
    imagesLoaded,
    xUp,
    minBreakpoint,
    uNavColWidth,
    uNavRowHeight,
    uNavOuterHeight,
    isHighRes,
    hasCssTransitions,
    justTriggered,

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>At least jQuery 1.7 is needed to use $.on() - if using an older version, change them to $.bind().
This will allow versions older than 1.7 to work without using depreciated functions in version 1.7+</p>             </td>             <td class="code">               <div class="highlight"><pre>    ON = $.isFunction( $.fn.on ) ? <span class="string">'on'</span> : <span class="string">'bind'</span>,
    OFF = $.isFunction( $.fn.off ) ? <span class="string">'off'</span> : <span class="string">'unbind'</span>,

  _init = <span class="keyword">function</span>($_triggerLink, $_pageWrapInner, $_pageWrapOuter, _minBreakpoint) {

    $window = $( window );
    $triggerLink = $_triggerLink;
    $pageWrapInner = $_pageWrapInner;
    $pageWrapOuter = $_pageWrapOuter;
    minBreakpoint = _minBreakpoint;
    $uNav = $(<span class="string">'#universal-nav'</span>);
    $uNavPrimary = $uNav.find(<span class="string">'.u-nav-primary'</span>);
    $firstChild = $uNavPrimary.children().first();
    $closeBtn = $(<span class="string">'#u-nav-close-btn'</span>);
    $tabableElements = $uNav.find(<span class="string">'[tabindex]'</span>);
    $lastTabIndexElement = $(<span class="string">'#u-nav-last-tabindex'</span>);
    isHighRes = <span class="literal">false</span>;
    imagesInited = <span class="literal">false</span>;
    imagesLoaded = <span class="literal">false</span>;
    xUp = $uNavPrimary.children().length;
    isHighRes = _isRetina();
    hasCssTransitions = _browserCssTransitionDetect();
    justTriggered = <span class="literal">false</span>;

    $(document)[ ON ](<span class="string">"universal-nav-open"</span>,<span class="keyword">function</span>(e){
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>console.log("universal-nav-open");</p>             </td>             <td class="code">               <div class="highlight"><pre>    });
    $(document)[ ON ](<span class="string">"universal-nav-open-finished"</span>,<span class="keyword">function</span>(e){
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>console.log("universal-nav-open-finished");</p>             </td>             <td class="code">               <div class="highlight"><pre>    });
    $(document)[ ON ](<span class="string">"universal-nav-close"</span>,<span class="keyword">function</span>(e){
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>console.log("universal-nav-close");</p>             </td>             <td class="code">               <div class="highlight"><pre>    });
    $(document)[ ON ](<span class="string">"universal-nav-close-finished"</span>,<span class="keyword">function</span>(e){
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>console.log("universal-nav-close-finished");</p>             </td>             <td class="code">               <div class="highlight"><pre>    });

</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <hr />

<h2>EVENT LISTENERS</h2>             </td>             <td class="code">               <div class="highlight"><pre>    $triggerLink[ ON ](<span class="string">'click focus'</span>,<span class="keyword">function</span>(e) {
      e.preventDefault();
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>console.log("$triggerLink[ ON ]('click focus')");</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="keyword">if</span> (!justTriggered){        
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>console.log("$triggerLink[ ON ]('click focus') - FIRE!");</p>             </td>             <td class="code">               <div class="highlight"><pre>        justTriggered = <span class="literal">true</span>;
        setTimeout( <span class="keyword">function</span>(){ justTriggered = <span class="literal">false</span>; }, <span class="number">100</span> );

        $triggerLink.addClass(<span class="string">'unav-focused'</span>);

        <span class="keyword">if</span> ( _minBreakpointMet()) {
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>console.log("##minBreakpointMet");</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="keyword">if</span> ($pageWrapOuter.hasClass(<span class="string">'unav-open'</span>)) {
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>console.log("hasClass(unav-open)");</p>             </td>             <td class="code">               <div class="highlight"><pre>            _closeUNav();
          } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>console.log("NOT hasClass(unav-open)");</p>             </td>             <td class="code">               <div class="highlight"><pre>            _openUNav();
          }
        }
      }
    });
    $triggerLink[ ON ](<span class="string">'blur'</span>,<span class="keyword">function</span>(e) {
      e.preventDefault();
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>console.log("$triggerLink[ ON ]('blur')");</p>             </td>             <td class="code">               <div class="highlight"><pre>      $triggerLink.removeClass(<span class="string">'unav-focused'</span>);
    });

    $tabableElements[ ON ](<span class="string">'focus'</span>,<span class="keyword">function</span>(e) {
      e.preventDefault();
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>console.log("$tabableElements[ ON ]('focus')");</p>             </td>             <td class="code">               <div class="highlight"><pre>
      $(e.target).addClass(<span class="string">'unav-focused'</span>);

      <span class="keyword">if</span> ($(e.target).attr(<span class="string">'id'</span>) == <span class="string">"u-nav-last-tabindex"</span>){
        <span class="keyword">if</span> (!$pageWrapOuter.hasClass(<span class="string">'unav-open'</span>) &amp;&amp; _minBreakpointMet()){
          _openUNav();
        }
      }
    });

    $tabableElements[ ON ](<span class="string">'blur'</span>,<span class="keyword">function</span>(e) {
</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>console.log("$tabableElements[ ON ]('blur')");
console.log("$lastTabIndexElement: " + $lastTabIndexElement);</p>             </td>             <td class="code">               <div class="highlight"><pre>
      $(e.target).removeClass(<span class="string">'unav-focused'</span>);

      <span class="keyword">if</span> ($(e.target).attr(<span class="string">'id'</span>) == <span class="string">"u-nav-last-tabindex"</span>){
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>give the focus a moment to add the focused class before checking to see if it exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>        setTimeout(<span class="keyword">function</span>(){
</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>if you just tabbed off of the last-tabindex link, and nothing inside uNav has focus (cuz this one just got blurred), close the u-nav.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="keyword">if</span> ($(<span class="string">'.unav-focused'</span>).length &lt; <span class="number">1</span>){
</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>console.log("#### Tabbed past the end!");</p>             </td>             <td class="code">               <div class="highlight"><pre>            _closeUNav();
          }
        },<span class="number">25</span>);
      }
    });

    $closeBtn[ ON ](<span class="string">'click'</span>,<span class="keyword">function</span>(e) {
      e.preventDefault();
      _closeUNav();
    });


</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Rolling our own quick &amp; dirrty throttle.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">var</span> throttleTimeout = <span class="literal">null</span>;
    $window.resize( <span class="keyword">function</span>() {
      <span class="keyword">if</span> (!throttleTimeout) {
        throttleTimeout = setTimeout(<span class="keyword">function</span>() {
          throttleTimeout = <span class="literal">null</span>;
          _resizeEvent();
        }, <span class="number">283</span>); <span class="comment">// Using a somewhat arbitrary delay in an attempt to avoid firing at the same time as anything else that might be throttled.</span>
      }
    });


    <span class="keyword">if</span> ( _minBreakpointMet() ) {
      _setUpPrimaryLinks();
    }
    <span class="keyword">if</span> ($(<span class="string">'html'</span>).hasClass(<span class="string">'lt-ie9'</span>)){
      _setUpCloseBtnOldIE();
    }
  },


  _openUNav = <span class="keyword">function</span>() {

    $(document).trigger(<span class="string">"universal-nav-open"</span>);

    !imagesInited &amp;&amp; _initialLoadImages();
    _setUpPrimaryLinks();

    $pageWrapOuter.addClass(<span class="string">'unav-open unav-open-until-transition-end'</span>);

    <span class="keyword">if</span> (hasCssTransitions) {
</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>console.log("??? uNavOuterHeight: " + uNavOuterHeight);</p>             </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>console.log("set pageWrapInner margin-top. uNavOuterHeight: " + uNavOuterHeight);</p>             </td>             <td class="code">               <div class="highlight"><pre>
      $uNav.css(<span class="string">'top'</span>, <span class="string">'-'</span> + uNavOuterHeight + <span class="string">'px'</span>);
      $pageWrapInner
      .css(<span class="string">'margin-top'</span>, uNavOuterHeight + <span class="string">'px'</span>)
      [ ON ](<span class="string">'transitionend webkitTransitionEnd oTransitionEnd otransitionend'</span>, <span class="keyword">function</span>(e){
</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>console.log("$(e.target): " , $(e.target), e.delegateTarget);</p>             </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>if ($(e.delegateTarget).is($(e.target)) &amp;&amp; !triggered){</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="keyword">if</span> ($(e.target).is($pageWrapInner)){
</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>triggered = true;</p>             </td>             <td class="code">               <div class="highlight"><pre>          $(document).trigger(<span class="string">"universal-nav-open-finished"</span>);
          $pageWrapInner[ OFF ](<span class="string">'transitionend webkitTransitionEnd oTransitionEnd otransitionend'</span>);
        }
      });
    } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>console.log("set pageWrapInner margin-top. uNavOuterHeight: " + uNavOuterHeight);</p>             </td>             <td class="code">               <div class="highlight"><pre>
      $uNav.css({ <span class="string">'top'</span>: <span class="string">'-'</span>+uNavOuterHeight+<span class="string">'px'</span>  ,  <span class="string">'height'</span>:uNavOuterHeight+<span class="string">'px'</span> });
      $pageWrapInner.animate({ <span class="string">'marginTop'</span>: uNavOuterHeight + <span class="string">'px'</span>}, <span class="number">400</span>, <span class="keyword">function</span>() {
        $(document).trigger(<span class="string">"universal-nav-open-finished"</span>);
      });
    }
  },

  _closeUNav = <span class="keyword">function</span>() {
    $(document).trigger(<span class="string">"universal-nav-close"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>was working on scrolling to the top when the universal nav is collapsed. Turned out buggy &amp; don't have time to clean it up.
var unavClose<em>ScrollToTop</em>int = setInterval(function(){
console.log("$('#nav-wrapper').offset().top: " + $('#nav-wrapper').offset().top);
console.log("$(document).scrollTop(): " + $(document).scrollTop());
var topOfNavOffset = $(document).scrollTop() - $('#nav-wrapper').offset().top;
console.log("topOfNavOffset: " + topOfNavOffset);
if (topOfNavOffset &lt; 5){
  window.scrollTo(0, $('#nav-wrapper').offset().top);
}
},2);</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="keyword">if</span> (hasCssTransitions) {
      $pageWrapInner
      .css(<span class="string">'margin-top'</span>, <span class="string">'0px'</span>)
      [ ON ](<span class="string">'transitionend webkitTransitionEnd oTransitionEnd otransitionend'</span>, <span class="keyword">function</span>(e){
</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>console.log("_closeUNav transitionend");
console.log("$(e.target): " , e.target);
console.log("$(e.delegateTarget): " , e.delegateTarget);</p>             </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>make sure that the event that just finished is $pageWrapInner; otherwise it may trigger a transitionend for something else inside of $pageWrapInner.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="keyword">if</span> ($(e.target).is($pageWrapInner)){
</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>console.log("$(e.delegateTarget).is($(e.target))");
triggered = true;
clearInterval(unavClose<em>ScrollToTop</em>int);</p>             </td>             <td class="code">               <div class="highlight"><pre>          $(document).trigger(<span class="string">"universal-nav-close-finished"</span>);
          $pageWrapOuter.removeClass(<span class="string">'unav-open unav-open-until-transition-end'</span>);
          $pageWrapInner.css(<span class="string">'margin-top'</span>, <span class="string">''</span>)[ OFF ](<span class="string">'transitionend webkitTransitionEnd oTransitionEnd otransitionend'</span>);
        } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>console.log("NOT $(e.delegateTarget).is($(e.target))");</p>             </td>             <td class="code">               <div class="highlight"><pre>        }
      });
    } <span class="keyword">else</span> {
      $pageWrapInner.animate({ <span class="string">'marginTop'</span>: <span class="string">'0px'</span>}, <span class="number">400</span>,  <span class="keyword">function</span>() {
</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>clearInterval(unavClose<em>ScrollToTop</em>int);</p>             </td>             <td class="code">               <div class="highlight"><pre>        $(document).trigger(<span class="string">"universal-nav-close-finished"</span>);
        $pageWrapOuter.removeClass(<span class="string">'unav-open-until-transition-end unav-open'</span>);
      });
    }
  },



  _setUpPrimaryLinks = <span class="keyword">function</span>() {
</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>console.log("_setUpPrimaryLinks");</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">var</span> x5upRatio,
        x3upRatio,
        x6upRatio,
        uNavRowHeight,
        primaryCaptionHeight,
        firstChildWidth;

    <span class="keyword">if</span> (imagesLoaded) {
</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>if images are loaded, use their natural height</p>             </td>             <td class="code">               <div class="highlight"><pre>      uNavRowHeight = $uNavPrimary.outerHeight();
    } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>So we don't have to download the images before we can figure out how high the module will be,
we need to figure out the height the image should be at this width, which is based on current browser width.
So based on the image aspect ratio, what height should the images, &amp; the whole uPrimaryNav be at this width?</p>             </td>             <td class="code">               <div class="highlight"><pre>      x5upRatio = <span class="number">0.8915</span>;
      x3upRatio = <span class="number">0.4205</span>;
      x6upRatio = <span class="number">0.3455</span>;

      uNavColWidth = $(<span class="string">'.u-nav-primary-row1'</span>).first().outerWidth();
      primaryCaptionHeight = $firstChild.find(<span class="string">'.u-nav-primary-caption'</span>).outerHeight( <span class="literal">true</span> );
      firstChildWidth = $firstChild.outerWidth();

      <span class="keyword">if</span> (xUp === <span class="number">3</span>) {
        uNavRowHeight = (firstChildWidth * x3upRatio) + primaryCaptionHeight;
      } <span class="keyword">else</span> <span class="keyword">if</span> (xUp === <span class="number">6</span>) {
        uNavRowHeight = (((uNavColWidth * x6upRatio) + primaryCaptionHeight) * <span class="number">2</span>) + <span class="number">36</span>;
      } <span class="keyword">else</span> {
        uNavRowHeight = (uNavColWidth * x5upRatio) + primaryCaptionHeight;
      }

</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>anything with a "row1" or "row2" is a half-height</p>             </td>             <td class="code">               <div class="highlight"><pre>      $(<span class="string">'.u-nav-primary-row1 .u-nav-primary-img-wrap, .u-nav-primary-row2 .u-nav-primary-img-wrap'</span>).css( <span class="string">'height'</span>, uNavColWidth * x6upRatio );
      $(<span class="string">'.u-nav-primary-col1.u-nav-primary-2high .u-nav-primary-img-wrap'</span>).css( <span class="string">'height'</span>, uNavColWidth * x5upRatio );
      $(<span class="string">'.u-nav-primary-col1.u-nav-primary-2wide .u-nav-primary-img-wrap'</span>).css( <span class="string">'height'</span>, firstChildWidth * x3upRatio );
    }

    $uNavPrimary.css(<span class="string">'height'</span>, uNavRowHeight + <span class="string">'px'</span>);
</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>now that we set the height of the images container, we can grab the height of the entire u-nav for our js.</p>             </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>setTimeout(function() {</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">var</span> primaryImgHeight = $firstChild.find(<span class="string">'.u-nav-primary-img'</span>).height();
      uNavOuterHeight = $uNav.outerHeight();
</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>console.log("_setUpPrimaryLinks. Set uNavOuterHeight: " + uNavOuterHeight);
once we have the outerheight, clear the custom height from the $uNavPrimary so it's back to the natural flow.
delays just to make sure the new heights are set before the next step.
if ( primaryImgHeight > 0 ) {
  $uNavPrimary.css( 'height', '' );
}
set the height to make sure there aren't rounding errors, where 'top' and 'height' are 1px or 1/2px off, and you can see a little bit when the u-nav is closed</p>             </td>             <td class="code">               <div class="highlight"><pre>      $uNav.css(<span class="string">'top'</span>, <span class="string">'-'</span> + uNavOuterHeight + <span class="string">'px'</span>);
      <span class="keyword">if</span> ( $pageWrapOuter.hasClass(<span class="string">'unav-open'</span>) ) {
        $pageWrapInner.css(<span class="string">'margin-top'</span>, uNavOuterHeight + <span class="string">'px'</span>);
      }
</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>}, 0);</p>             </td>             <td class="code">               <div class="highlight"><pre>  },

  _initialLoadImages = <span class="keyword">function</span>() {
    imagesInited = <span class="literal">true</span>;

    setTimeout(<span class="keyword">function</span>() {

</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>load the close btn icon first.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">var</span> $closeBtnImg = $(<span class="string">'#u-nav-close-btn .u-nav-close-btn-img'</span>);
      <span class="keyword">var</span> closeBtnImgSrcStr = $closeBtnImg.attr(<span class="string">'data-src-desktop'</span>);
      <span class="keyword">if</span> (isHighRes){
        closeBtnImgSrcStr = $closeBtnImg.attr(<span class="string">'data-src-desktop-highres'</span>);
      }
      $closeBtnImg.attr(<span class="string">'src'</span>, closeBtnImgSrcStr);

      <span class="keyword">var</span> $uNavPrimaryImages = $uNavPrimary.find(<span class="string">'.u-nav-primary-img'</span>),
        imagesLoadedCount = <span class="number">0</span>;

      $uNavPrimaryImages.each(<span class="keyword">function</span>() {
        <span class="keyword">var</span> $thImg = $(<span class="keyword">this</span>);
        <span class="keyword">var</span> srcStr = $thImg.attr(<span class="string">'data-src-desktop'</span>);
        <span class="keyword">if</span> (isHighRes){
          srcStr = $thImg.attr(<span class="string">'data-src-desktop-highres'</span>);
        } 

        $thImg.attr(<span class="string">'src'</span>, srcStr);
        $thImg[ ON ](<span class="string">'load'</span>, <span class="keyword">function</span>() {
          imagesLoadedCount++;
</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>now that the image is loaded, clear out the custom height on the image wrapper</p>             </td>             <td class="code">               <div class="highlight"><pre>          $thImg.addClass(<span class="string">'opacity1'</span>).parent().css(<span class="string">'height'</span>,<span class="string">""</span>);
          setTimeout(<span class="keyword">function</span>() {
            $thImg.parent().css(<span class="string">'background-image'</span>,<span class="string">'none'</span>);
          },<span class="number">300</span>); <span class="comment">// wait til the image is faded in before pulling off the preloader graphic (which needs to be hidden because it would show through on hover)</span>
          <span class="keyword">if</span> (imagesLoadedCount === $uNavPrimaryImages.length) {
            imagesLoaded = <span class="literal">true</span>;
            uNavOuterHeight = $uNav.outerHeight();
</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>once all the images are loaded, re-set up the primary links. ..is this needed?</p>             </td>             <td class="code">               <div class="highlight"><pre>            _setUpPrimaryLinks();
          }
        });
      });
    },<span class="number">0</span>); <span class="comment">// leave at 0 unless testing the image preloader.</span>
  },


  _setUpCloseBtnOldIE = <span class="keyword">function</span>() {
</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>for lt-ie9, the button needs an explicit width or it breaks to 2 lines. Since we don't know how long the i11n text will be, we gotta do some math.
alert("_setUpCloseBtnOldIE");</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">var</span> $closeBtn = $(<span class="string">'#u-nav-close-btn'</span>),
      labelWidth = $closeBtn.find(<span class="string">'.u-nav-close-btn-label'</span>).outerWidth(<span class="literal">true</span>),
      iconWidth = $closeBtn.find(<span class="string">'.u-nav-close-btn-img-container'</span>).outerWidth(<span class="literal">true</span>),
      buttonWidth = labelWidth + iconWidth + <span class="number">1</span>;
    $closeBtn.width(buttonWidth);
  },

</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>in case Modernizr isn't available, let's do our own check for css transitions.
via http://stackoverflow.com/questions/7264899/detect-css-transitions-using-javascript-and-without-modernizr</p>             </td>             <td class="code">               <div class="highlight"><pre>  _browserCssTransitionDetect = <span class="keyword">function</span>() {
    <span class="keyword">var</span> s = document.createElement(<span class="string">'p'</span>).style;
    <span class="keyword">return</span> <span class="string">'transition'</span> <span class="keyword">in</span> s || <span class="string">'WebkitTransition'</span> <span class="keyword">in</span> s || <span class="string">'MozTransition'</span> <span class="keyword">in</span> s || <span class="string">'msTransition'</span> <span class="keyword">in</span> s || <span class="string">'OTransition'</span> <span class="keyword">in</span> s;
  },

</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>in case Modernizr isn't available, figure out if this is a high-rez display
https://github.com/imulus/retinajs/blob/master/src/retina.js</p>             </td>             <td class="code">               <div class="highlight"><pre>  _isRetina = <span class="keyword">function</span>() {
    <span class="keyword">var</span> mediaQuery = <span class="string">"(-webkit-min-device-pixel-ratio: 1.5),(min--moz-device-pixel-ratio: 1.5),(-o-min-device-pixel-ratio: 3/2),(min-resolution: 1.5dppx)"</span>;
    <span class="keyword">var</span> root = (<span class="keyword">typeof</span> exports == <span class="string">'undefined'</span> ? window : exports);
    <span class="keyword">if</span> (root.devicePixelRatio &gt; <span class="number">1</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }

    <span class="keyword">if</span> (_matchMedia(mediaQuery).matches) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }

    <span class="keyword">return</span> <span class="literal">false</span>;
  },
</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>needed for _isRetina to work
https://github.com/paulirish/matchMedia.js</p>             </td>             <td class="code">               <div class="highlight"><pre>  _matchMedia = <span class="keyword">function</span>() {
    <span class="keyword">var</span> bool,
      doc = document,
      docElem = doc.documentElement,
      refNode = docElem.firstElementChild || docElem.firstChild,
</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>fakeBody required for <FF4 when executed in <head></p>             </td>             <td class="code">               <div class="highlight"><pre>      fakeBody = doc.createElement( <span class="string">"body"</span> ),
      div = doc.createElement( <span class="string">"div"</span> );

    div.id = <span class="string">"mq-test-1"</span>;
    div.style.cssText = <span class="string">"position:absolute;top:-100em"</span>;
    fakeBody.style.background = <span class="string">"none"</span>;
    fakeBody.appendChild(div);

    <span class="keyword">return</span> <span class="keyword">function</span>(q) {
      div.innerHTML = <span class="string">"&amp;shy;&lt;style media=\""</span> + q + <span class="string">"\"&gt; #mq-test-1 { width: 42px; }&lt;/style&gt;"</span>;
      docElem.insertBefore( fakeBody, refNode );
      bool = div.offsetWidth === <span class="number">42</span>;
      docElem.removeChild( fakeBody );

      <span class="keyword">return</span> {
        matches: bool,
        media: q
      };
    };
  },

  _minBreakpointMet = <span class="keyword">function</span>() {
    <span class="keyword">return</span> minBreakpoint &lt;= parseInt( $window.width(), <span class="number">10</span> );
  },

  _resizeEvent = <span class="keyword">function</span>() {
    <span class="keyword">if</span> ( _minBreakpointMet() ) {
      _setUpPrimaryLinks();
    } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>hide &amp; reset!</p>             </td>             <td class="code">               <div class="highlight"><pre>      $pageWrapOuter.removeClass(<span class="string">'unav-open unav-open-until-transition-end'</span>);
      $pageWrapInner.css(<span class="string">'margin-top'</span>,<span class="string">''</span>);
    }
  };

  <span class="keyword">return</span> {
    init: _init
  };

})(window, document, jQuery);


</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Document.ready call</p>             </td>             <td class="code">               <div class="highlight"><pre>$(<span class="keyword">function</span>() {
  <span class="keyword">if</span> ($(<span class="string">'#universal-nav'</span>).length) {
    UNAV.init($(<span class="string">'#nav-li-link-universal'</span>), $(<span class="string">'#page-wrap-inner'</span>), $(<span class="string">'#page-wrap-outer'</span>), <span class="number">768</span>);
  }
});


</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 