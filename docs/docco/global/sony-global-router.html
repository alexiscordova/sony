<!DOCTYPE html>  <html> <head>   <title>sony-global-router.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="sony-global-analytics.html">                 sony-global-analytics.js               </a>                                           <a class="source" href="sony-global-environment.html">                 sony-global-environment.js               </a>                                           <a class="source" href="sony-global-router.html">                 sony-global-router.js               </a>                                           <a class="source" href="sony-global-settings.html">                 sony-global-settings.js               </a>                                           <a class="source" href="sony-global-utilities.html">                 sony-global-utilities.js               </a>                                           <a class="source" href="sony-global.html">                 sony-global.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               sony-global-router.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Sony Router Class</h2>

<ul>
<li><strong>Class:</strong> SONY.Router</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>
define(<span class="function"><span class="keyword">function</span> <span class="params">(require)</span> {</span>

  <span class="string">'use strict'</span>;

  <span class="keyword">var</span> $ = require(<span class="string">'jquery'</span>),
      Modernizr = require(<span class="string">'modernizr'</span>),
      Environment = require(<span class="string">'require/sony-global-environment'</span>),
      Settings = require(<span class="string">'require/sony-global-settings'</span>);

  <span class="keyword">var</span> _router;

  <span class="keyword">var</span> router = {
    <span class="string">'init'</span>: <span class="keyword">function</span>() {
      _router = <span class="keyword">new</span> Router();
    },

    <span class="string">'on'</span>: <span class="keyword">function</span>(route, cb) {
      _router.addRoute(route, cb);
    },

    <span class="string">'off'</span>: <span class="keyword">function</span>(route) {
      _router.removeRoute(route);
    }
  };

  <span class="keyword">var</span> Router = <span class="keyword">function</span>(element){
    <span class="keyword">var</span> self = <span class="keyword">this</span>;

    self.routeStripper = <span class="regexp">/^[#\/]|\s+$/g</span>;
    self.init();
  };

  Router.prototype = {

    constructor: Router,

    init: <span class="keyword">function</span>() {

      <span class="keyword">var</span> self = <span class="keyword">this</span>;

      self.routes = [];

      <span class="keyword">if</span> ( Modernizr.hashchange &amp;&amp; !Settings.isLTIE8 ) {
        Settings.$window.on(<span class="string">'hashchange'</span>, <span class="keyword">function</span>(){
          self.checkUrl();
        });
      } <span class="keyword">else</span> {
        self._checkUrlInterval = setInterval(<span class="keyword">function</span>(){
          self.checkUrl();
        }, <span class="number">500</span>);
      }

      self.checkUrl();

      log(<span class="string">'SONY : Global : Router : Initialized'</span>);
    },

    addRoute: <span class="keyword">function</span>(route, cb) {

      <span class="keyword">var</span> self = <span class="keyword">this</span>,
          routeData;

      <span class="keyword">if</span> ( <span class="keyword">typeof</span> route === <span class="string">'string'</span> &amp;&amp; <span class="keyword">typeof</span> cb === <span class="string">'function'</span> ) {

        routeData = {
          <span class="string">'route'</span>: route,
          <span class="string">'cb'</span>: cb
        };

        self.routes.push(routeData);

        self.checkUrl(routeData);
      }
    },

    removeRoute: <span class="keyword">function</span>(route) {

      <span class="keyword">var</span> self = <span class="keyword">this</span>;

      <span class="keyword">for</span> ( <span class="keyword">var</span> i = <span class="number">0</span>; i &lt; self.routes.length; i++ ) {

        <span class="keyword">if</span> ( self.routes[i].route === route ) {
          self.routes.splice(i, <span class="number">1</span>);
        }
      }
    },

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Check the current URL and</p>             </td>             <td class="code">               <div class="highlight"><pre>
    checkUrl: <span class="keyword">function</span>(routeData) {

      <span class="keyword">var</span> self = <span class="keyword">this</span>,
          current = self.getFragment(),
          match;

      <span class="keyword">if</span> (current === self.fragment &amp;&amp; !routeData) {
        <span class="keyword">return</span> <span class="literal">false</span>;
      }

      <span class="keyword">if</span> ( routeData ) {
        match = current.match(self.routeToRegExp(routeData.route));
        <span class="keyword">if</span> ( match ) {
          routeData.cb.apply(window, match.slice(<span class="number">1</span>));
        }
        <span class="keyword">return</span>;
      }

      <span class="keyword">for</span> ( <span class="keyword">var</span> i = <span class="number">0</span>; i &lt; self.routes.length; i++ ) {
        match = current.match(self.routeToRegExp(self.routes[i].route));
        <span class="keyword">if</span> ( match ) {
          self.routes[i].cb.apply(window, match.slice(<span class="number">1</span>));
        }
      }

      self.fragment = current;
    },

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Strips route from hash if present (x-browser smoothing).</p>             </td>             <td class="code">               <div class="highlight"><pre>
    getFragment: <span class="keyword">function</span>(fragment) {

      <span class="keyword">var</span> self = <span class="keyword">this</span>;

      <span class="keyword">if</span> (!fragment) {
        fragment = self.getHash();
      }
      <span class="keyword">return</span> fragment.replace(self.routeStripper, <span class="string">''</span>);
    },

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Get current window hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    getHash: <span class="keyword">function</span>() {
      <span class="keyword">var</span> match = window.location.href.match(<span class="regexp">/#(.*)$/</span>);
      <span class="keyword">return</span> match ? match[<span class="number">1</span>] : <span class="string">''</span>;
    },

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Converts routes into regular expressions that can be used by <code>.match()</code></p>             </td>             <td class="code">               <div class="highlight"><pre>
    routeToRegExp: <span class="keyword">function</span>(route) {

      <span class="keyword">var</span> optionalParam = <span class="regexp">/\((.*?)\)/g</span>,
          namedParam    = <span class="regexp">/(\(\?)?:\w+/g</span>,
          splatParam    = <span class="regexp">/\*\w+/g</span>,
          escapeRegExp  = <span class="regexp">/[\-{}\[\]+?.,\\\^$|#\s]/g</span>;

      route = route.replace(escapeRegExp, <span class="string">'\\$&amp;'</span>)
                   .replace(optionalParam, <span class="string">'(?:$1)?'</span>)
                   .replace(namedParam, <span class="keyword">function</span>(match, optional){ <span class="keyword">return</span> optional ? match : <span class="string">'([^\/]+)'</span>; })
                   .replace(splatParam, <span class="string">'(.*?)'</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> RegExp(<span class="string">'^'</span> + route + <span class="string">'$'</span>);
    }

  };

  <span class="keyword">return</span> router;

});
</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 